"use strict";const fs=require("fs");var stream=null,logfile_time=null,logfile_name=null;const Promise=require("bluebird"),del=require("del"),Config=require("./config");var child_process=require("child_process"),PATH=require("path");function get_time(e){return{year:e.getFullYear()-2e3,month:e.getMonth()+1,day:e.getDate(),hour:e.getHours(),minute:e.getMinutes(),second:e.getSeconds()}}function get_logfile_name(e=null){return e||(e=logfile_time),logfile_name=module.exports.config.log_dir+String(e.year)+(e.month<10?"0":"")+e.month+(e.day<10?"0"+e.day:e.day)+".log"}function get_time_str(e){return String(e.year)+(e.month<10?"0":"")+e.month+(e.day<10?"0"+e.day:e.day)+"-"+(e.hour<10?"0"+e.hour:e.hour)+(e.minute<10?"0"+e.minute:e.minute)+(e.second<10?"0"+e.second:e.second)}function get_log_str(e,t,r){var o=get_time(module.exports.Date()),n=function(e){return e?"string"==typeof e?e:e.toString?e.toString().replace("\\n","\n"):JSON.stringify(e):""},i="";return"error"!=e&&"warn"!=e||(i+="\n",t&&t.stack?i+=t.stack:r&&r.stack?i+=r.stack:"error"==e&&(i+=(new Error).stack)),get_time_str(o)+","+e+","+n(t)+n(r)+i}function remove_old_log_files(){return fs.promises.readdir(module.exports.config.log_dir).then((e=>{if(e.length>7){(e=e.map((e=>PATH.join(module.exports.config.log_dir,e)))).sort((function(e,t){return fs.statSync(e).mtime.getTime()-fs.statSync(t).mtime.getTime()}));for(var t=0;t<e.length-7;t++)fs.promises.unlink(e[t])}}))}function check_dir_exist(e){return fs.promises.access(e,fs.constants.F_OK).catch((t=>"ENOENT"===t.code?fs.promises.mkdir(e).then((()=>{module.exports.log("info","dir created : "+e)})):(module.exports.log("error","check_dir_exist() : fs.access failed "+e,t),Promise.reject(t))))}function create_random_string(e){const t="abcdefghijklmnpqrstuvwxyz123456789";for(var r="",o=0;o<e;o++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}module.exports={init:function(e={}){return logfile_time=get_time(this.Date()),Config.load(module.exports).then((e=>(module.exports.config=e,process.env.NODE_ENV="production",stream=fs.createWriteStream(get_logfile_name(logfile_time),{flags:"a"}),module.exports.log("info","port = "+module.exports.config.port),module.exports.log("info","log = "+logfile_name),remove_old_log_files())))},get_time:get_time,get_time_str:get_time_str,log:function(e,t,r){var o=get_log_str(e,t,r);console.log(o),stream&&stream.write(o+"\n")},end:function(){stream&&(stream.end(),stream=null),timer_clear_cache&&clearInterval(timer_clear_cache)},log_wait:function(e,t,r,o){if(stream){var n=get_log_str(e,r,o);console.log(n),stream.write(n+"\n",t)}else t()},log_sync:function(e,t,r){stream&&(stream.end(),stream=null);var o=get_log_str(e,t,r);console.log(o),fs.appendFileSync(logfile_name,o+"\n")},remove_old_log_files:remove_old_log_files,is_release:function(){return"release"==this.config.app_mode},check_dir_exist:check_dir_exist,get_logfile_name:get_logfile_name,create_random_string:create_random_string,isNaN:function(e){return null==e||isNaN(e)||""===e},del:function(e,t=!0){return new Promise(((r,o)=>{setTimeout((()=>{del(e,{force:!0,dryRun:!1}).then((n=>{t&&0==n.length?(module.exports.log("warn","my.del : cannot remove : "+e),o()):r()}))}),100)}))},move_file:function(e,t){return module.exports.log("info","move_file: "+e+" => "+t),fs.promises.copyFile(e,t).then((()=>fs.promises.unlink(e)))},copy_all:function(e,t){return fs.promises.readdir(e,{withFileTypes:!0}).then((r=>Promise.all(r.map((r=>r.isFile()?fs.promises.copyFile(PATH.join(e,r.name),PATH.join(t,r.name)):check_dir_exist(PATH.join(t,r.name)).then((()=>module.exports.copy_all(PATH.join(e,r.name),PATH.join(t,r.name)))))))))},Date:function(e){return e?new Date(e):new Date},alert:function(e,t="Alert",r=!1){var o="powershell.exe",n=[`Add-Type -AssemblyName PresentationCore,PresentationFramework;[System.Windows.MessageBox]::Show('${e}','${t}');`];r?child_process.spawnSync(o,n):child_process.spawn(o,n)}},require.main===module&&module.exports.init();